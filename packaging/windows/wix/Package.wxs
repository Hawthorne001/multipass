<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs" xmlns:ui="http://wixtoolset.org/schemas/v4/wxs/ui">
    <Package Name="Multipass" Manufacturer="Canonical Ltd" Version="$(Version)" UpgradeCode="faebc626-1491-49bb-8162-22b1684013d9">
        <MajorUpgrade DowngradeErrorMessage="!(loc.DowngradeError)" />

        <MediaTemplate EmbedCab="yes" />
        <Icon Id="mp.exe" SourceFile="icon.ico" />
        <Property Id="ARPPRODUCTICON" Value="mp.exe" />
        <Property Id="ARPURLINFOABOUT" Value="https://multipass.run/" />
        <Property Id="ARPHELPLINK" Value="https://github.com/CanonicalLtd/multipass" />

        <Binary Id="CABinary" SourceFile="$(var.CustomActions.TargetDir)\$(var.CustomActions.TargetName).CA.dll" />

        <FeatureRef Id="Main" />

        <ui:WixUI Id="CustomWixUI_InstallDir"  InstallDirectory="INSTALLFOLDER" />

        <Property Id="MP_INSTALLED">
            <RegistrySearch Id="MP_INSTALLED" Root="HKLM" Key="SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\Multipass" Name="UninstallString" Type="raw" />
        </Property>
        <Property Id="MP_INSTALLED6432">
            <RegistrySearch Id="MP_INSTALLED6432" Root="HKLM" Key="SOFTWARE\WOW6432Node\Microsoft\Windows\CurrentVersion\Uninstall\Multipass" Name="UninstallString" Type="raw" />
        </Property>

        <CustomAction Id="UninstallExeMP.SetProperty" Property="UninstallExeMP" Value="[MP_INSTALLED];[MP_INSTALLED6432]" />
        <CustomAction Id="UninstallExeMP" BinaryRef="CABinary" DllEntry="UninstallOldMP" Return="check" Execute="deferred" Impersonate="no" />

        <InstallExecuteSequence>
            <Custom Action="UninstallExeMP.SetProperty" Before="UninstallExeMP" Condition="NOT Installed AND (MP_INSTALLED OR MP_INSTALLED6432)" />
            <Custom Action="UninstallExeMP" After="InstallInitialize" Condition="NOT Installed AND (MP_INSTALLED OR MP_INSTALLED6432)" />
        </InstallExecuteSequence>
    </Package>

    <Fragment>
        <Feature Id="Main">
            <ComponentGroupRef Id="CLIClientComponents" />
            <ComponentGroupRef Id="DaemonComponents" />
            <ComponentGroupRef Id="GUIComponents" />
            <ComponentRef Id="Fonts" />
            <ComponentRef Id="Licence" />
            <ComponentGroupRef Id="MultipassSupportComponents" />
        </Feature>
    </Fragment>

    <Fragment>
        <Component Id="Fonts" Directory="FontsFolder">
            <File Source="UbuntuMono-R.ttf" TrueType="true" />
            <RegistryValue Root="HKLM" Key="SOFTWARE\Microsoft\Windows NT\CurrentVersion\Fonts" Name="Ubuntu Mono (TrueType)" Value="UbuntuMono-R.ttf" />
        </Component>

        <Component Id="Licence" Directory="INSTALLFOLDER">
            <File Source="UBUNTU-LICENCE.txt" />
        </Component>
    </Fragment>

    <Fragment>
        <StandardDirectory Id="ProgramFiles6432Folder">
            <Directory Id="INSTALLFOLDER" Name="!(bind.Property.ProductName)">
                <Directory Id="BinFolder" Name="bin" />
            </Directory>
        </StandardDirectory>
    </Fragment>
</Wix>
