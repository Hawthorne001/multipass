<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs" xmlns:ui="http://wixtoolset.org/schemas/v4/wxs/ui">
    <Package Name="Multipass" Manufacturer="Canonical Ltd" Version="$(Version)" UpgradeCode="faebc626-1491-49bb-8162-22b1684013d9">
        <MajorUpgrade AllowDowngrades="yes" />
        <Launch Condition="Installed OR WIN_VERSION >= 17134" Message="!(loc.FeatureUpdateReqd)" />

        <MediaTemplate EmbedCab="yes" />
        <Icon Id="mp.exe" SourceFile="icon.ico" />
        <Property Id="ARPPRODUCTICON" Value="mp.exe" />
        <Property Id="ARPURLINFOABOUT" Value="https://multipass.run/" />
        <Property Id="ARPHELPLINK" Value="https://github.com/CanonicalLtd/multipass" />

        <Property Id="WIN_VERSION">
            <RegistrySearch Id='WinVersion' Type='raw' Root='HKLM' Key='SOFTWARE\Microsoft\Windows NT\CurrentVersion' Name='CurrentBuildNumber' />
        </Property>

        <Binary Id="CABinary" SourceFile="$(var.CustomActions.TargetDir)\$(var.CustomActions.TargetName).CA.dll" />

        <FeatureRef Id="Main" />

        <ui:WixUI Id="CustomWixUI_InstallDir"  InstallDirectory="INSTALLFOLDER" />

        <Property Id="MP_INSTALLED">
            <RegistrySearch Id="MP_INSTALLED" Root="HKLM" Key="SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\Multipass" Name="UninstallString" Type="raw" />
        </Property>
        <Property Id="MP_INSTALLED6432">
            <RegistrySearch Id="MP_INSTALLED6432" Root="HKLM" Key="SOFTWARE\WOW6432Node\Microsoft\Windows\CurrentVersion\Uninstall\Multipass" Name="UninstallString" Type="raw" />
        </Property>

        <CustomAction Id="UninstallExeMP.SetProperty" Property="UninstallExeMP" Value="[MP_INSTALLED];[MP_INSTALLED6432]" />
        <CustomAction Id="UninstallExeMP" BinaryRef="CABinary" DllEntry="UninstallOldMP" Return="check" Execute="deferred" Impersonate="no" />

        <InstallExecuteSequence>
            <Custom Action="UninstallExeMP.SetProperty" Before="UninstallExeMP" Condition="NOT Installed AND (MP_INSTALLED OR MP_INSTALLED6432)" />
            <Custom Action="UninstallExeMP" After="InstallInitialize" Condition="NOT Installed AND (MP_INSTALLED OR MP_INSTALLED6432)" />
        </InstallExecuteSequence>

        <!-- Remove Multipass data -->
        <Property Id="REMOVE_DATA" Value="YES" />
        <Property Id="RemoveDataText" Value="!(loc.RemoveMPData)" />

        <SetProperty Id="RemoveMPDataScript" Before="RemoveMPDataScript" Sequence="execute"
            Value ="&quot;[%ComSpec]&quot; /c &apos;&quot;[BinFolder]multipass.exe&quot; delete -p --all &amp;
            rmdir /S /Q &quot;[CommonAppDataFolder]Multipass&quot; &quot;[LocalAppDataFolder]multipass&quot; &quot;[LocalAppDataFolder]multipass-client-certificate&quot; &quot;[SystemFolder]config\systemprofile\AppData\Local\multipassd&quot; &quot;[SystemFolder]config\systemprofile\AppData\Roaming\multipassd&quot;&apos;" />

        <CustomAction Id="AskRemoveDataMsgBox" BinaryRef="CABinary" DllEntry="AskRemoveData" Return="ignore" />
        <CustomAction Id="RemoveMPDataScript" BinaryRef="Wix4UtilCA_$(sys.BUILDARCHSHORT)" DllEntry="WixQuietExec" Execute="deferred" Return="ignore" Impersonate="no" />

        <InstallExecuteSequence>
            <Custom Action="AskRemoveDataMsgBox" Before="InstallInitialize" Condition="Installed AND REMOVE~=&quot;ALL&quot; AND (NOT UPGRADINGPRODUCTCODE)" />
            <Custom Action="RemoveMPDataScript" After="InstallInitialize" Condition="Installed AND REMOVE~=&quot;ALL&quot; AND (NOT UPGRADINGPRODUCTCODE) AND REMOVE_DATA=&quot;YES&quot;" />
        </InstallExecuteSequence>

        <!-- Install client certificates -->
        <CustomAction Id="InstallClientCertsAction.SetCmdLine" Execute="immediate" Property="WixQuietExecCmdLine" Value="&quot;[%ComSpec]&quot; /c &quot;[BinFolder]multipassd.exe&quot; /install" />
        <CustomAction Id="InstallClientCertsAction" BinaryRef="Wix4UtilCA_$(sys.BUILDARCHSHORT)" DllEntry="WixQuietExec" Execute="immediate" Return="ignore" />

        <InstallExecuteSequence>
            <Custom Action="InstallClientCertsAction.SetCmdLine" Before="InstallClientCertsAction" />
            <Custom Action="InstallClientCertsAction" After="InstallFinalize" />
        </InstallExecuteSequence>

        <!-- Detect Windows edition and set driver -->
        <Property Id="WINDOWS_EDITION" Secure="yes">
            <RegistrySearch Id="WINDOWS_EDITION" Root="HKLM" Key="SOFTWARE\Microsoft\Windows NT\CurrentVersion" Name="EditionID" Type="raw" />
        </Property>
        <CustomAction Id="SetWindowsEdition" Property="DRIVER" Value="virtualbox" />
        <InstallExecuteSequence>
            <Custom Action="SetWindowsEdition" After="AppSearch" Condition="WINDOWS_EDITION &gt;&lt; &quot;Core&quot;" />
        </InstallExecuteSequence>

        <!-- Create Multipass daemon configuration file -->
        <Property Id="MP_DATA_DIR">
            <RegistrySearch Id="MultipassDataDirRegKey" Root="HKLM" Key="SYSTEM\CurrentControlSet\Control\Session Manager\Environment" Name="MULTIPASS_STORAGE" Type="raw" />
        </Property>

        <Property Id="CONFIG_FILE_FOUND">
            <DirectorySearch Id="MultipassDataDir" AssignToProperty="yes" Path="[MP_DATA_DIR]">
                <FileSearch Id="multipass_conf" Name="multipassd.conf" />
            </DirectorySearch>
        </Property>

        <CustomAction Id="SetMP_DATA_DIR" Execute="immediate" Property="MP_DATA_DIR" Value="[CommonAppDataFolder]Multipass\" />
        <CustomAction Id="DaemonConfigFileAction.SetCmdLine" Execute="immediate" Property="WixQuietExecCmdLine" Value="&quot;[%ComSpec]&quot; /c echo local.driver=[DRIVER] &gt; &quot;[MP_DATA_DIR]multipassd.conf&quot;" />
        <CustomAction Id="DaemonConfigFileAction" BinaryRef="Wix4UtilCA_$(sys.BUILDARCHSHORT)" DllEntry="WixQuietExec" Return="ignore" Execute="immediate" />

        <InstallUISequence>
            <Custom Action="SetMP_DATA_DIR" Before="AppSearch" />
        </InstallUISequence>
        <InstallExecuteSequence>
            <Custom Action="SetMP_DATA_DIR" Before="AppSearch" />
            <Custom Action="DaemonConfigFileAction.SetCmdLine" Before="DaemonConfigFileAction" Condition="NOT CONFIG_FILE_FOUND" />
            <Custom Action="DaemonConfigFileAction" After="InstallClientCertsAction" Condition="NOT CONFIG_FILE_FOUND" />
        </InstallExecuteSequence>
    </Package>

    <Fragment>
        <Feature Id="Main">
            <ComponentGroupRef Id="CLIClientComponents" />
            <ComponentGroupRef Id="DaemonComponents" />
            <ComponentGroupRef Id="GUIComponents" />
            <ComponentGroupRef Id="AdditionalComponents" />
            <ComponentGroupRef Id="MultipassSupportComponents" />
        </Feature>
    </Fragment>

    <Fragment>
        <ComponentGroup Id="AdditionalComponents" Directory="INSTALLFOLDER">
            <Component Directory="FontsFolder">
                <File Source="UbuntuMono-R.ttf" TrueType="true" />
                <RegistryValue Root="HKLM" Key="SOFTWARE\Microsoft\Windows NT\CurrentVersion\Fonts" Name="Ubuntu Mono (TrueType)" Value="UbuntuMono-R.ttf" />
            </Component>

            <Component>
                <File Source="UBUNTU-LICENCE.txt" />
            </Component>

            <Component>
                <RegistryKey Root="HKLM" Key="SOFTWARE\Microsoft\Windows\CurrentVersion\App Paths\multipass.exe">
                    <RegistryValue Value="[INSTALLFOLDER]bin\multipass.exe" />
                    <RegistryValue Name="Path" Value="[INSTALLFOLDER]bin" />
                </RegistryKey>
            </Component>
        </ComponentGroup>
    </Fragment>

    <Fragment>
        <StandardDirectory Id="ProgramFiles6432Folder">
            <Directory Id="INSTALLFOLDER" Name="!(bind.Property.ProductName)">
                <Directory Id="BinFolder" Name="bin" />
            </Directory>
        </StandardDirectory>
    </Fragment>
</Wix>
